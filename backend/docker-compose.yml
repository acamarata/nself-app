
services:
  postgres:
    image: postgres:16-alpine
    container_name: nself-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-nself}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - staging
      - production

  graphql-engine:
    image: hasura/graphql-engine:v2.42.0
    container_name: nself-hasura
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nself}
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-nself-admin-secret}
      HASURA_GRAPHQL_ENABLE_CONSOLE: ${HASURA_ENABLE_CONSOLE:-true}
      HASURA_GRAPHQL_DEV_MODE: ${HASURA_DEV_MODE:-true}
      HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: anonymous
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256","key":"${JWT_SECRET:-nself-jwt-secret-change-this-in-production}"}'
      HASURA_GRAPHQL_ENABLE_TELEMETRY: false
    ports:
      - "${HASURA_PORT:-8080}:8080"
    volumes:
      - ./hasura/metadata:/hasura-metadata
      - ./hasura/migrations:/hasura-migrations
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - staging
      - production

  auth:
    image: nhost/hasura-auth:0.32.1
    container_name: nself-auth
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      graphql-engine:
        condition: service_healthy
    environment:
      AUTH_HOST: 0.0.0.0
      AUTH_PORT: ${AUTH_PORT:-4000}
      HASURA_GRAPHQL_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nself}
      HASURA_GRAPHQL_GRAPHQL_URL: http://graphql-engine:8080/v1/graphql
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-nself-admin-secret}
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256","key":"${JWT_SECRET:-nself-jwt-secret-change-this-in-production}"}'
      AUTH_CLIENT_URL: ${AUTH_CLIENT_URL:-http://localhost:3000}
      AUTH_SERVER_URL: ${AUTH_SERVER_URL:-http://localhost:4000}
      AUTH_SMTP_HOST: ${SMTP_HOST:-mailhog}
      AUTH_SMTP_PORT: ${SMTP_PORT:-1025}
      AUTH_SMTP_USER: ${SMTP_USER:-}
      AUTH_SMTP_PASS: ${SMTP_PASS:-}
      AUTH_SMTP_SENDER: ${SMTP_SENDER:-noreply@nself.local}
      AUTH_SMTP_SECURE: ${SMTP_SECURE:-false}
      AUTH_ACCESS_TOKEN_EXPIRES_IN: ${AUTH_ACCESS_TOKEN_EXPIRES_IN:-900}
      AUTH_REFRESH_TOKEN_EXPIRES_IN: ${AUTH_REFRESH_TOKEN_EXPIRES_IN:-2592000}
    ports:
      - "${AUTH_PORT:-4000}:4000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - staging
      - production

  storage:
    image: nhost/hasura-storage:0.6.1
    container_name: nself-storage
    restart: unless-stopped
    command: serve
    depends_on:
      postgres:
        condition: service_healthy
      graphql-engine:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      BIND: :8484
      HASURA_GRAPHQL_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nself}
      HASURA_GRAPHQL_GRAPHQL_URL: http://graphql-engine:8080/v1/graphql
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-nself-admin-secret}
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${STORAGE_BUCKET:-nself}
      S3_ROOT_FOLDER: ${STORAGE_ROOT_FOLDER:-}
    ports:
      - "${STORAGE_PORT:-8484}:8484"
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -f http://localhost:8484/healthz || exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    profiles:
      - dev
      - staging
      - production

  minio:
    image: minio/minio:latest
    container_name: nself-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - staging
      - production

  mailhog:
    image: mailhog/mailhog:latest
    container_name: nself-mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8025 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev

volumes:
  postgres_data:
    name: nself_postgres_data
  minio_data:
    name: nself_minio_data

networks:
  default:
    name: nself_network
